generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
  NUMERIC
}

enum QuestionStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum QuestionDifficulty {
  VERY_EASY
  EASY
  MEDIUM
  HARD
  VERY_HARD
}

enum ExamPackageStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  TIMED_OUT
  ABANDONED
}

enum TransactionStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

enum PaymentMethod {
  QRIS
  BANK_TRANSFER
  EWALLET
  CREDIT_CARD
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
}

enum NotificationType {
  STUDY_REMINDER
  EXAM_DEADLINE
  SCORE_UPDATE
  PAYMENT_SUCCESS
  PACKAGE_NEW
  QUESTION_STATUS
  SYSTEM
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

enum CreditType {
  FREE_SIGNUP
  PURCHASE
  REFUND
  USAGE
  BONUS
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum Theme {
  DEFAULT
  CUTE
  OCEAN
  SUNSET
  FOREST
  NEON
  LAVENDER
}

enum EbookContentType {
  PDF
  HTML
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum LiveEventStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

enum NotificationProvider {
  PUSH
  WHATSAPP
}

// ============================================================
// USER & AUTH
// ============================================================

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified DateTime?
  passwordHash  String?
  name          String
  avatar        String?
  phone         String?    @unique
  role          UserRole   @default(STUDENT)
  status        UserStatus @default(ACTIVE)
  referralCode  String?    @unique
  referredById  String?
  lastLoginAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  referredBy      User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals       User[]   @relation("Referrals")
  accounts        Account[]
  sessions        Session[]
  profile         UserProfile?
  teacherProfile  TeacherProfile?
  attempts        ExamAttempt[]
  transactions    Transaction[]
  credits         UserCredit?
  creditHistory   CreditHistory[]
  studyPlans      StudyPlan[]
  notifications   Notification[]
  pushSubs        PushSubscription[]
  articles        Article[]
  ebooks          Ebook[]
  bookmarks       QuestionBookmark[]
  auditLogs       AuditLog[]
  leaderboard     LeaderboardEntry[]
  packageAccesses UserPackageAccess[]
  resetTokens     PasswordResetToken[]
  badges          UserBadge[]
  promoUsages     PromoUsage[]
  discussions     Discussion[]
  discussionVotes DiscussionVote[]
  dailyChallenges DailyChallengeAttempt[]
  subscriptions   Subscription[]
  liveEventRegs   LiveEventRegistration[]
  friendsAsUser   FriendComparison[]     @relation("FriendUser")
  friendsAsFriend FriendComparison[]     @relation("FriendTarget")
  offlineSyncs    OfflineSync[]
  parentLinks     ParentChild[]          @relation("ChildUser")
  childLinks      ParentChild[]          @relation("ParentUser")
  waSubscription  WhatsappSubscription?

  @@index([role])
  @@index([status])
  @@index([referralCode])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refreshToken      String?
  accessToken       String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  idToken           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model UserProfile {
  id                  String    @id @default(cuid())
  userId              String    @unique
  school              String?
  city                String?
  birthDate           DateTime?
  targetExam          String?
  bio                 String?
  theme               Theme     @default(DEFAULT)
  onboardingCompleted Boolean   @default(false)
  currentStreak       Int       @default(0)
  longestStreak       Int       @default(0)
  lastActiveDate      DateTime?
  notifyExamResult    Boolean   @default(true)
  notifyPayment       Boolean   @default(true)
  notifyPromo         Boolean   @default(true)
  notifyPush          Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================================
// TEACHER
// ============================================================

model TeacherProfile {
  id             String    @id @default(cuid())
  userId         String    @unique
  education      String
  specialization String[]
  institution    String?
  bio            String?
  isVerified     Boolean   @default(false)
  verifiedAt     DateTime?
  bankName       String?
  bankAccount    String?
  bankHolder     String?
  totalEarnings  Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  earnings TeacherEarning[]
  payouts  PayoutRequest[]

  @@map("teacher_profiles")
}

model TeacherEarning {
  id               String   @id @default(cuid())
  teacherProfileId String
  questionId       String
  amount           Int
  attemptCount     Int
  period           String
  createdAt        DateTime @default(now())

  teacherProfile TeacherProfile @relation(fields: [teacherProfileId], references: [id])
  question       Question       @relation(fields: [questionId], references: [id])

  @@unique([teacherProfileId, questionId, period])
  @@index([teacherProfileId])
  @@map("teacher_earnings")
}

model PayoutRequest {
  id               String       @id @default(cuid())
  teacherProfileId String
  amount           Int
  bankName         String
  bankAccount      String
  bankHolder       String
  status           PayoutStatus @default(PENDING)
  processedAt      DateTime?
  processedBy      String?
  rejectionReason  String?
  createdAt        DateTime     @default(now())

  teacherProfile TeacherProfile @relation(fields: [teacherProfileId], references: [id])

  @@index([status])
  @@map("payout_requests")
}

// ============================================================
// EXAM CATEGORIES
// ============================================================

model ExamCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subCategories ExamSubCategory[]
  packages      ExamPackage[]
  studyPlans    StudyPlan[]

  @@map("exam_categories")
}

model ExamSubCategory {
  id         String   @id @default(cuid())
  categoryId String
  name       String
  slug       String
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  category ExamCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  subjects Subject[]

  @@unique([categoryId, slug])
  @@map("exam_sub_categories")
}

model Subject {
  id            String   @id @default(cuid())
  subCategoryId String
  name          String
  slug          String
  order         Int      @default(0)
  createdAt     DateTime @default(now())

  subCategory ExamSubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)
  topics      Topic[]
  sections    ExamSection[]

  @@unique([subCategoryId, slug])
  @@map("subjects")
}

model Topic {
  id        String   @id @default(cuid())
  subjectId String
  name      String
  slug      String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  subject   Subject    @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions Question[]

  @@unique([subjectId, slug])
  @@map("topics")
}

// ============================================================
// QUESTIONS
// ============================================================

model Question {
  id          String             @id @default(cuid())
  topicId     String
  createdById String
  type        QuestionType       @default(SINGLE_CHOICE)
  status      QuestionStatus     @default(DRAFT)
  difficulty  QuestionDifficulty @default(MEDIUM)
  content     String
  explanation String?
  videoUrl    String?
  source      String?
  year        Int?
  imageUrl    String?
  metadata    Json?
  usageCount  Int                @default(0)
  correctRate Float              @default(0)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNote  String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  topic           Topic                 @relation(fields: [topicId], references: [id])
  options         QuestionOption[]
  sectionItems    ExamSectionQuestion[]
  answers         ExamAnswer[]
  bookmarks       QuestionBookmark[]
  teacherEarnings TeacherEarning[]
  discussions     Discussion[]
  dailyChallenges DailyChallenge[]

  @@index([topicId])
  @@index([status])
  @@index([createdById])
  @@index([type, difficulty])
  @@map("questions")
}

model QuestionOption {
  id         String  @id @default(cuid())
  questionId String
  label      String
  content    String
  imageUrl   String?
  isCorrect  Boolean @default(false)
  order      Int     @default(0)

  question Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers  ExamAnswer[]

  @@index([questionId])
  @@map("question_options")
}

model QuestionBookmark {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@map("question_bookmarks")
}

// ============================================================
// EXAM PACKAGES
// ============================================================

model ExamPackage {
  id              String            @id @default(cuid())
  categoryId      String
  title           String
  slug            String            @unique
  description     String?
  price           Int               @default(0)
  discountPrice   Int?
  durationMinutes Int
  totalQuestions  Int
  passingScore    Int?
  isFree          Boolean           @default(false)
  isAntiCheat     Boolean           @default(true)
  isCatMode       Boolean           @default(false)
  status          ExamPackageStatus @default(DRAFT)
  startDate       DateTime?
  endDate         DateTime?
  maxAttempts     Int               @default(1)
  bundleId        String?
  createdById     String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  category        ExamCategory       @relation(fields: [categoryId], references: [id])
  bundle          SubscriptionBundle? @relation(fields: [bundleId], references: [id])
  sections        ExamSection[]
  attempts        ExamAttempt[]
  transactions    Transaction[]
  leaderboard     LeaderboardEntry[]
  packageAccesses UserPackageAccess[]
  liveEvents      LiveEvent[]

  @@index([categoryId])
  @@index([status])
  @@index([isFree])
  @@index([bundleId])
  @@map("exam_packages")
}

model ExamSection {
  id              String @id @default(cuid())
  packageId       String
  subjectId       String
  title           String
  durationMinutes Int
  totalQuestions  Int
  order           Int    @default(0)

  package   ExamPackage           @relation(fields: [packageId], references: [id], onDelete: Cascade)
  subject   Subject               @relation(fields: [subjectId], references: [id])
  questions ExamSectionQuestion[]

  @@index([packageId])
  @@map("exam_sections")
}

model ExamSectionQuestion {
  id         String @id @default(cuid())
  sectionId  String
  questionId String
  order      Int    @default(0)

  section  ExamSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  question Question    @relation(fields: [questionId], references: [id])

  @@unique([sectionId, questionId])
  @@index([sectionId, order])
  @@map("exam_section_questions")
}

// ============================================================
// EXAM ATTEMPTS & ANSWERS
// ============================================================

model ExamAttempt {
  id              String        @id @default(cuid())
  userId          String
  packageId       String
  status          AttemptStatus @default(IN_PROGRESS)
  score           Float?
  totalCorrect    Int?
  totalIncorrect  Int?
  totalUnanswered Int?
  percentile      Float?
  startedAt       DateTime      @default(now())
  finishedAt      DateTime?
  serverStartedAt DateTime      @default(now())
  serverDeadline  DateTime
  violations      Int           @default(0)
  sectionTimers   Json?
  metadata        Json?

  user        User                @relation(fields: [userId], references: [id])
  package     ExamPackage         @relation(fields: [packageId], references: [id])
  answers     ExamAnswer[]
  tabEvents   TabViolationEvent[]
  leaderboard LeaderboardEntry?

  @@index([userId])
  @@index([packageId])
  @@index([status])
  @@index([userId, packageId])
  @@map("exam_attempts")
}

model ExamAnswer {
  id               String   @id @default(cuid())
  attemptId        String
  questionId       String
  selectedOptionId String?
  selectedOptions  String[]
  numericAnswer    Float?
  isCorrect        Boolean?
  timeSpentSeconds Int      @default(0)
  isFlagged        Boolean  @default(false)
  answeredAt       DateTime @default(now())

  attempt  ExamAttempt     @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question Question        @relation(fields: [questionId], references: [id])
  option   QuestionOption? @relation(fields: [selectedOptionId], references: [id])

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@map("exam_answers")
}

model TabViolationEvent {
  id        String   @id @default(cuid())
  attemptId String
  type      String
  timestamp DateTime @default(now())
  details   String?

  attempt ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@map("tab_violation_events")
}

// ============================================================
// LEADERBOARD
// ============================================================

model LeaderboardEntry {
  id        String   @id @default(cuid())
  packageId String
  userId    String
  attemptId String   @unique
  score     Float
  rank      Int?
  createdAt DateTime @default(now())

  package ExamPackage @relation(fields: [packageId], references: [id])
  user    User        @relation(fields: [userId], references: [id])
  attempt ExamAttempt @relation(fields: [attemptId], references: [id])

  @@unique([packageId, userId])
  @@index([packageId, score(sort: Desc)])
  @@map("leaderboard_entries")
}

// ============================================================
// PAYMENTS & CREDITS
// ============================================================

model Transaction {
  id            String            @id @default(cuid())
  userId        String
  packageId     String?
  amount        Int
  paymentMethod PaymentMethod?
  status        TransactionStatus @default(PENDING)
  midtransId    String?           @unique
  midtransUrl   String?
  snapToken     String?
  paidAt        DateTime?
  expiredAt     DateTime?
  metadata      Json?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  user    User         @relation(fields: [userId], references: [id])
  package ExamPackage? @relation(fields: [packageId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([midtransId])
  @@index([createdAt])
  @@map("transactions")
}

model UserCredit {
  id          String   @id @default(cuid())
  userId      String   @unique
  balance     Int      @default(0)
  freeCredits Int      @default(0)
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_credits")
}

model CreditHistory {
  id          String     @id @default(cuid())
  userId      String
  amount      Int
  type        CreditType
  description String?
  referenceId String?
  createdAt   DateTime   @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("credit_history")
}

// ============================================================
// SCHEDULE PLANNER
// ============================================================

model StudyPlan {
  id          String    @id @default(cuid())
  userId      String
  categoryId  String?
  title       String
  description String?
  targetDate  DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category ExamCategory? @relation(fields: [categoryId], references: [id])
  tasks    StudyTask[]

  @@index([userId])
  @@map("study_plans")
}

model StudyTask {
  id          String    @id @default(cuid())
  planId      String
  title       String
  description String?
  date        DateTime
  startTime   String?
  duration    Int?
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  priority    Int       @default(0)
  repeatRule  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  plan StudyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId, date])
  @@map("study_tasks")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        String              @id @default(cuid())
  userId    String
  type      NotificationType
  channel   NotificationChannel @default(IN_APP)
  title     String
  message   String
  data      Json?
  isRead    Boolean             @default(false)
  readAt    DateTime?
  sentAt    DateTime            @default(now())
  createdAt DateTime            @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, type])
  @@map("notifications")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

// ============================================================
// BLOG / ARTICLES
// ============================================================

model Article {
  id          String        @id @default(cuid())
  authorId    String
  title       String
  slug        String        @unique
  content     String
  excerpt     String?
  coverImage  String?
  category    String?
  tags        String[]
  status      ArticleStatus @default(DRAFT)
  publishedAt DateTime?
  viewCount   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  author User @relation(fields: [authorId], references: [id])

  @@index([status, publishedAt])
  @@map("articles")
}

// ============================================================
// EBOOKS
// ============================================================

model Ebook {
  id            String           @id @default(cuid())
  authorId      String
  title         String
  slug          String           @unique
  description   String?
  coverImage    String?
  contentType   EbookContentType @default(HTML)
  htmlContent   String?
  pdfUrl        String?
  fileSize      Int?
  pageCount     Int?
  category      String?
  tags          String[]
  status        ArticleStatus    @default(DRAFT)
  viewCount     Int              @default(0)
  downloadCount Int              @default(0)
  publishedAt   DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  author User @relation(fields: [authorId], references: [id])

  @@index([status, publishedAt])
  @@map("ebooks")
}

// ============================================================
// AUDIT LOG
// ============================================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  oldData   Json?
  newData   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================
// USER PACKAGE ACCESS (Direct grant by admin)
// ============================================================

model UserPackageAccess {
  id        String    @id @default(cuid())
  userId    String
  packageId String
  grantedBy String
  grantedAt DateTime  @default(now())
  expiresAt DateTime?
  reason    String?

  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  package ExamPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([userId, packageId])
  @@index([userId])
  @@index([packageId])
  @@map("user_package_accesses")
}

model AiProviderConfig {
  id        String   @id @default(cuid())
  provider  String   @unique
  apiKey    String
  model     String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_provider_configs")
}

// ============================================================
// ANNOUNCEMENTS
// ============================================================

model Announcement {
  id        String    @id @default(cuid())
  message   String
  type      String    @default("info")
  linkUrl   String?
  linkText  String?
  isActive  Boolean   @default(true)
  startAt   DateTime  @default(now())
  endAt     DateTime?
  createdAt DateTime  @default(now())

  @@map("announcements")
}

// ============================================================
// PASSWORD RESET
// ============================================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

// ============================================================
// GAMIFICATION â€” Badges & XP
// ============================================================

model Badge {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String
  icon        String
  category    String
  requirement Json
  xpReward    Int      @default(0)
  createdAt   DateTime @default(now())

  users UserBadge[]

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

// ============================================================
// PROMO CODES
// ============================================================

model PromoCode {
  id            String    @id @default(cuid())
  code          String    @unique
  description   String?
  discountType  String    @default("PERCENTAGE")
  discountValue Int
  minPurchase   Int       @default(0)
  maxUses       Int?
  usedCount     Int       @default(0)
  validFrom     DateTime  @default(now())
  validUntil    DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  usages PromoUsage[]

  @@index([code])
  @@map("promo_codes")
}

model PromoUsage {
  id          String   @id @default(cuid())
  promoCodeId String
  userId      String
  orderId     String?
  discount    Int
  usedAt      DateTime @default(now())

  promoCode PromoCode @relation(fields: [promoCodeId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([promoCodeId, userId])
  @@map("promo_usages")
}

// ============================================================
// FEATURE 5: Discussion Forum per Soal
// ============================================================

model Discussion {
  id         String   @id @default(cuid())
  questionId String
  userId     String
  parentId   String?
  content    String
  upvotes    Int      @default(0)
  downvotes  Int      @default(0)
  isEdited   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  question Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Discussion?      @relation("DiscussionReplies", fields: [parentId], references: [id])
  replies  Discussion[]     @relation("DiscussionReplies")
  votes    DiscussionVote[]

  @@index([questionId])
  @@index([userId])
  @@index([parentId])
  @@map("discussions")
}

model DiscussionVote {
  id           String   @id @default(cuid())
  discussionId String
  userId       String
  value        Int      // 1 = upvote, -1 = downvote
  createdAt    DateTime @default(now())

  discussion Discussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([discussionId, userId])
  @@map("discussion_votes")
}

// ============================================================
// FEATURE 8: Daily Challenge & Streak
// ============================================================

model DailyChallenge {
  id         String   @id @default(cuid())
  questionId String
  date       DateTime @db.Date
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())

  question Question               @relation(fields: [questionId], references: [id])
  attempts DailyChallengeAttempt[]

  @@unique([date])
  @@index([date, isActive])
  @@map("daily_challenges")
}

model DailyChallengeAttempt {
  id               String   @id @default(cuid())
  dailyChallengeId String
  userId           String
  selectedOptionId String?
  numericAnswer    Float?
  isCorrect        Boolean
  timeSpentSeconds Int      @default(0)
  createdAt        DateTime @default(now())

  dailyChallenge DailyChallenge @relation(fields: [dailyChallengeId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([dailyChallengeId, userId])
  @@index([userId])
  @@map("daily_challenge_attempts")
}

// ============================================================
// FEATURE 3: Subscription & Bundle
// ============================================================

model SubscriptionBundle {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  categoryId  String?
  monthlyPrice  Int
  quarterlyPrice Int?
  yearlyPrice    Int?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  packages      ExamPackage[]
  subscriptions Subscription[]

  @@map("subscription_bundles")
}

model Subscription {
  id          String             @id @default(cuid())
  userId      String
  bundleId    String
  plan        SubscriptionPlan
  status      SubscriptionStatus @default(ACTIVE)
  startDate   DateTime           @default(now())
  endDate     DateTime
  autoRenew   Boolean            @default(false)
  amount      Int
  midtransId  String?            @unique
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  user   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  bundle SubscriptionBundle @relation(fields: [bundleId], references: [id])

  @@index([userId, status])
  @@index([endDate])
  @@map("subscriptions")
}

// ============================================================
// FEATURE 6: Live Event (Tryout Bersama)
// ============================================================

model LiveEvent {
  id            String          @id @default(cuid())
  packageId     String
  title         String
  description   String?
  scheduledAt   DateTime
  endAt         DateTime?
  status        LiveEventStatus @default(SCHEDULED)
  maxParticipants Int?
  createdById   String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  package       ExamPackage            @relation(fields: [packageId], references: [id])
  registrations LiveEventRegistration[]

  @@index([scheduledAt])
  @@index([status])
  @@map("live_events")
}

model LiveEventRegistration {
  id          String    @id @default(cuid())
  eventId     String
  userId      String
  attemptId   String?
  registeredAt DateTime @default(now())

  event LiveEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("live_event_registrations")
}

// ============================================================
// FEATURE 9: Friend Comparison
// ============================================================

model FriendComparison {
  id          String   @id @default(cuid())
  userId      String
  friendId    String
  packageId   String?
  inviteCode  String   @unique @default(cuid())
  isAccepted  Boolean  @default(false)
  createdAt   DateTime @default(now())

  user   User @relation("FriendUser", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("FriendTarget", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friend_comparisons")
}

// ============================================================
// FEATURE 10: Offline Mode Sync
// ============================================================

model OfflineSync {
  id         String   @id @default(cuid())
  userId     String
  attemptId  String?
  data       Json
  syncType   String   // "answer" | "attempt_complete"
  isSynced   Boolean  @default(false)
  syncedAt   DateTime?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isSynced])
  @@map("offline_syncs")
}

// ============================================================
// FEATURE 11: WhatsApp Notification
// ============================================================

model WhatsappSubscription {
  id          String   @id @default(cuid())
  userId      String   @unique
  phoneNumber String
  isActive    Boolean  @default(true)
  remindSchedule  Boolean @default(true)
  remindResult    Boolean @default(true)
  remindEvent     Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("whatsapp_subscriptions")
}

// ============================================================
// FEATURE 12: Parent Dashboard
// ============================================================

model ParentChild {
  id        String   @id @default(cuid())
  parentId  String
  childId   String
  isPending Boolean  @default(true)
  inviteCode String  @unique @default(cuid())
  createdAt DateTime @default(now())

  parent User @relation("ParentUser", fields: [parentId], references: [id], onDelete: Cascade)
  child  User @relation("ChildUser", fields: [childId], references: [id], onDelete: Cascade)

  @@unique([parentId, childId])
  @@map("parent_children")
}
